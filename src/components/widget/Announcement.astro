---
import { Icon } from "astro-icon/components";
import { announcementConfig } from "../../config";
import I18nKey from "../../i18n/i18nKey";
import { i18n } from "../../i18n/translation";
import WidgetLayout from "./WidgetLayout.astro";

const config = announcementConfig;

interface Props {
	class?: string;
	style?: string;
}
const className = Astro.props.class;
const style = Astro.props.style;
---

<!-- ÁªÑ‰ª∂ÊòæÁ§∫Áé∞Âú®Áî±sidebarLayoutConfigÁªü‰∏ÄÊéßÂà∂ÔºåÊó†ÈúÄÊ£ÄÊü•config.enable -->
<WidgetLayout 
    name={config.title || i18n(I18nKey.announcement)} 
    id="announcement"
    class={className} 
    style={style}
>
    <div>
        <!-- ÂÖ¨ÂëäÊ†èÂÜÖÂÆπ -->
        <div class="text-neutral-600 dark:text-neutral-300 leading-relaxed mb-3">
            {config.content}
        </div>
        
        <!-- ÂèØÈÄâÈìæÊé•ÂíåÂÖ≥Èó≠ÊåâÈíÆ -->
        <div class="flex items-center justify-between gap-3">
            <div>
                {config.link && config.link.enable !== false && (
                    <a 
                        href={config.link.url} 
                        target={config.link.external ? "_blank" : "_self"}
                        rel={config.link.external ? "noopener noreferrer" : undefined}
                        class="btn-regular rounded-lg px-3 py-1.5 text-sm font-medium active:scale-95 transition-transform"
                    >
                        {config.link.text}

                    </a>
                )}
            </div>
            
            {config.closable && (
                <button 
                    class="btn-regular rounded-lg h-8 w-8 text-sm hover:bg-red-100 dark:hover:bg-red-900/30 transition-colors"
                    onclick="closeAnnouncement()"
                    aria-label={i18n(I18nKey.announcementClose)}
                >
                    <Icon name="fa6-solid:xmark" class="text-sm" />
                </button>
            )}
        </div>
    </div>
</WidgetLayout>

<script>
    function closeAnnouncement() {
        // ÈÄöËøádata-idÂ±ûÊÄßÊâæÂà∞Êï¥‰∏™widget-layoutÂÖÉÁ¥†
        const widgetLayout = document.querySelector('widget-layout[data-id="announcement"]') as HTMLElement | null;
        if (widgetLayout) {
            // ÈöêËóèÊï¥‰∏™widget-layoutÂÖÉÁ¥†
            widgetLayout.style.display = 'none';
            // ‰øùÂ≠òÂÖ≥Èó≠Áä∂ÊÄÅÂà∞localStorage
            localStorage.setItem('announcementClosed', 'true');
        }
    }

    // ÈáçÁΩÆÂÖ¨ÂëäÊ†èÊòæÁ§∫Áä∂ÊÄÅ
    function resetAnnouncement() {
        // Ê∏ÖÈô§ localStorage ‰∏≠ÁöÑÂÖ≥Èó≠Ê†áËÆ∞
        localStorage.removeItem('announcementClosed');
        // ÊâæÂà∞ÂÖ¨ÂëäÊ†èÂÖÉÁ¥†Âπ∂ÊòæÁ§∫
        const widgetLayout = document.querySelector('widget-layout[data-id="announcement"]') as HTMLElement | null;
        if (widgetLayout) {
            widgetLayout.style.display = '';
            console.log('‚úÖ ÂÖ¨ÂëäÊ†èÂ∑≤ÈáçÁΩÆÂπ∂ÊòæÁ§∫');
        } else {
            console.warn('‚ö†Ô∏è Êú™ÊâæÂà∞ÂÖ¨ÂëäÊ†èÂÖÉÁ¥†');
        }
    }

    // ËØäÊñ≠ÂáΩÊï∞ÔºöËæìÂá∫Ë∞ÉËØï‰ø°ÊÅØ
    function diagnoseAnnouncement() {
        console.group('üîç ÂÖ¨ÂëäÊ†èËØäÊñ≠‰ø°ÊÅØ');
        
        // 1. Ê£ÄÊü• localStorage
        const isClosed = localStorage.getItem('announcementClosed') === 'true';
        console.log('1. localStorage Áä∂ÊÄÅ:', isClosed ? '‚ùå Â∑≤ÂÖ≥Èó≠' : '‚úÖ Êú™ÂÖ≥Èó≠');
        
        // 2. Ê£ÄÊü•Ëá™ÂÆö‰πâÂÖÉÁ¥†
        const widgetLayoutRegistered = customElements.get('widget-layout');
        console.log('2. widget-layout Ëá™ÂÆö‰πâÂÖÉÁ¥†:', widgetLayoutRegistered ? '‚úÖ Â∑≤Ê≥®ÂÜå' : '‚ùå Êú™Ê≥®ÂÜå');
        
        // 3. Ê£ÄÊü• DOM ÂÖÉÁ¥†
        const widgetLayout = document.querySelector('widget-layout[data-id="announcement"]') as HTMLElement | null;
        console.log('3. DOM ÂÖÉÁ¥†:', widgetLayout ? '‚úÖ ÊâæÂà∞' : '‚ùå Êú™ÊâæÂà∞');
        
        if (widgetLayout) {
            console.log('   - ÊòæÁ§∫Áä∂ÊÄÅ:', window.getComputedStyle(widgetLayout).display);
            console.log('   - ÂèØËßÅÊÄß:', window.getComputedStyle(widgetLayout).visibility);
            console.log('   - ÂÖÉÁ¥†:', widgetLayout);
        }
        
        // 4. Ê£ÄÊü•‰æßËæπÊ†è
        const sidebar = document.getElementById('sidebar');
        console.log('4. ‰æßËæπÊ†èÂÖÉÁ¥†:', sidebar ? '‚úÖ ÊâæÂà∞' : '‚ùå Êú™ÊâæÂà∞');
        if (sidebar) {
            console.log('   - ÊòæÁ§∫Áä∂ÊÄÅ:', window.getComputedStyle(sidebar).display);
            console.log('   - ÂÖÉÁ¥†:', sidebar);
        }
        
        // 5. Ê£ÄÊü•ÁªÑ‰ª∂ÈÖçÁΩÆ
        const topComponents = Array.from(document.querySelectorAll('#sidebar > div:first-child > *'));
        console.log('5. ‰æßËæπÊ†èÈ°∂ÈÉ®ÁªÑ‰ª∂Êï∞Èáè:', topComponents.length);
        topComponents.forEach((comp, idx) => {
            console.log(`   - ÁªÑ‰ª∂ ${idx + 1}:`, comp.tagName, comp.getAttribute('data-id') || 'Êó†ID');
        });
        
        console.groupEnd();
        
        // ËøîÂõûËØäÊñ≠ÁªìÊûú
        return {
            isClosed,
            widgetLayoutRegistered: !!widgetLayoutRegistered,
            widgetLayoutFound: !!widgetLayout,
            sidebarFound: !!sidebar,
            topComponentsCount: topComponents.length
        };
    }

    // Ê£ÄÊü•Âπ∂Â∫îÁî®ÂÖ¨ÂëäÊ†èÂÖ≥Èó≠Áä∂ÊÄÅ
    function checkAnnouncementState() {
        // Á≠âÂæÖËá™ÂÆö‰πâÂÖÉÁ¥†Ê≥®ÂÜåÂÆåÊàê
        if (!customElements.get('widget-layout')) {
            // Â¶ÇÊûúËá™ÂÆö‰πâÂÖÉÁ¥†ËøòÊú™Ê≥®ÂÜåÔºåÂª∂ËøüÊ£ÄÊü•
            setTimeout(checkAnnouncementState, 100);
            return;
        }

        const widgetLayout = document.querySelector('widget-layout[data-id="announcement"]') as HTMLElement | null;
        if (widgetLayout) {
            const isClosed = localStorage.getItem('announcementClosed') === 'true';
            if (isClosed) {
                widgetLayout.style.display = 'none';
                console.log('üì¢ ÂÖ¨ÂëäÊ†èÂ∑≤Ê†πÊçÆ localStorage ÈöêËóè');
            } else {
                // Á°Æ‰øùÂ¶ÇÊûú localStorage ‰∏≠Ê≤°ÊúâÂÖ≥Èó≠Ê†áËÆ∞ÔºåÂÖ¨ÂëäÊ†èÊòØÊòæÁ§∫ÁöÑ
                widgetLayout.style.display = '';
                console.log('üì¢ ÂÖ¨ÂëäÊ†èÂ∫îËØ•ÊòæÁ§∫');
            }
        } else {
            console.warn('‚ö†Ô∏è Êú™ÊâæÂà∞ÂÖ¨ÂëäÊ†èÂÖÉÁ¥†ÔºåÊâßË°åËØäÊñ≠...');
            diagnoseAnnouncement();
        }
    }

    // È°µÈù¢Âä†ËΩΩÊó∂Ê£ÄÊü•ÊòØÂê¶Â∑≤ÂÖ≥Èó≠
    function initAnnouncementCheck() {
        // Á≠âÂæÖ DOM ÂíåËá™ÂÆö‰πâÂÖÉÁ¥†ÈÉΩÂáÜÂ§áÂ•Ω
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                // Âª∂Ëøü‰∏ÄÁÇπÊó∂Èó¥Á°Æ‰øùËá™ÂÆö‰πâÂÖÉÁ¥†Â∑≤Ê≥®ÂÜå
                setTimeout(checkAnnouncementState, 50);
            });
        } else {
            // DOMÂ∑≤ÁªèÂä†ËΩΩÂÆåÊàêÔºåÂª∂ËøüÊ£ÄÊü•Á°Æ‰øùËá™ÂÆö‰πâÂÖÉÁ¥†Â∑≤Ê≥®ÂÜå
            setTimeout(checkAnnouncementState, 50);
        }
    }

    // ÂàùÂßãÂåñÊ£ÄÊü•
    initAnnouncementCheck();

    // ÊîØÊåÅ Swup È°µÈù¢ËøáÊ∏°
    document.addEventListener('swup:page:view', () => {
        setTimeout(checkAnnouncementState, 100);
    });
    document.addEventListener('swup:content:replace', () => {
        setTimeout(checkAnnouncementState, 100);
    });
    
    // Â¶ÇÊûú Swup Â∞öÊú™ÂàùÂßãÂåñÔºåÁõëÂê¨ÂêØÁî®‰∫ã‰ª∂
    document.addEventListener('swup:enable', function() {
        const swup = (window as Window & { swup?: { hooks?: { on: (event: string, callback: () => void) => void } } }).swup;
        if (swup && swup.hooks) {
            swup.hooks.on('page:view', () => {
                setTimeout(checkAnnouncementState, 100);
            });
            swup.hooks.on('content:replace', () => {
                setTimeout(checkAnnouncementState, 100);
            });
        }
    });

    // ‰ΩøÂÖ¨ÂëäÊ†èÂáΩÊï∞ÂÖ®Â±ÄÂèØÁî®
    (window as Window & { closeAnnouncement?: () => void }).closeAnnouncement = closeAnnouncement;
    
    // Â∞ÜËØäÊñ≠ÂáΩÊï∞Êö¥Èú≤Âà∞ÂÖ®Â±ÄÔºåÊñπ‰æøÂú®ÊéßÂà∂Âè∞Ë∞ÉÁî®
    (window as Window & { diagnoseAnnouncement?: () => void }).diagnoseAnnouncement = diagnoseAnnouncement;
    
    // Â∞ÜÈáçÁΩÆÂáΩÊï∞Êö¥Èú≤Âà∞ÂÖ®Â±ÄÔºåÊñπ‰æøÂú®ÊéßÂà∂Âè∞Ë∞ÉÁî®
    (window as Window & { resetAnnouncement?: () => void }).resetAnnouncement = resetAnnouncement;
    
    // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéËá™Âä®ÊâßË°å‰∏ÄÊ¨°ËØäÊñ≠
    setTimeout(() => {
        console.log('üì¢ ÂÖ¨ÂëäÊ†èÁªÑ‰ª∂Â∑≤Âä†ËΩΩÔºåÊâßË°åËØäÊñ≠...');
        diagnoseAnnouncement();
    }, 1000);
</script>